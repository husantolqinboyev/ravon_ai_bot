<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ravon AI - User Panel</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <div id="loader"><div class="spinner"></div></div>

    <div class="container">
        <div id="view-home" class="view active">
            <div class="header">
                <h1>üéô Ravon AI</h1>
                <p>Nutqingizni ravon qiling</p>
            </div>

            <div class="card">
                <div class="card-title"><i></i>Asosiy Amallar</div>
                <button class="btn-action" onclick="sendToBot('check_pronunciation')">üéô Talaffuzni Tekshirish</button>
                <button class="btn-action secondary" onclick="sendToBot('text_to_audio')">üîä Matnni Audioga O'tkazish</button>
            </div>

            <div class="card">
                <div class="card-title"><i></i>Statistika</div>
                <div class="stats-grid" id="home-stats">
                    <div class="stat-item">
                        <span class="stat-value" id="total-tests">0</span>
                        <span class="stat-label">Jami testlar</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="avg-score">0</span>
                        <span class="stat-label">O'rtacha ball</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-profile" class="view">
            <div class="header"><h1>üë§ Profil</h1></div>
            
            <div class="card">
                <div class="card-title"><i></i>Foydalanuvchi ma'lumotlari</div>
                <div id="user-info">
                    <div class="info-row">
                        <span class="info-label">Ism:</span>
                        <span class="info-value" id="user-name">...</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ID:</span>
                        <span class="info-value" id="user-id">...</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Tarif:</span>
                        <span class="info-value" id="user-tariff">...</span>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-title"><i></i>Limitlar</div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <span class="stat-value" id="daily-limit">0/3</span>
                        <span class="stat-label">Kunlik foydalanish</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="word-limit">30</span>
                        <span class="stat-label">So'z limiti</span>
                    </div>
                </div>
            </div>

            <button class="btn-action premium-btn" onclick="switchView('view-tariffs')">üíé Premiumga o'tish</button>
        </div>

        <div id="view-tariffs" class="view">
            <div class="header"><h1>üí≥ Tariflar</h1></div>
            <div id="tariffs-list"></div>
        </div>
    </div>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="switchView('view-home', this)">
            <i>üè†</i><span>Asosiy</span>
        </div>
        <div class="nav-item" onclick="switchView('view-profile', this)">
            <i>üë§</i><span>Profil</span>
        </div>
        <div class="nav-item" onclick="switchView('view-tariffs', this)">
            <i>üíé</i><span>Tariflar</span>
        </div>
    </nav>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        let userData = null;
        const CACHE_TTL = 12 * 60 * 1000;
        const SOFT_REFRESH_AFTER = 90 * 1000;
        const MIN_FETCH_INTERVAL = 120 * 1000;
        let fetchPromise = null;
        let lastFetchAt = 0;

        function openDb() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('ravon-miniapp', 1);
                request.onupgradeneeded = () => {
                    const db = request.result;
                    if (!db.objectStoreNames.contains('userData')) {
                        db.createObjectStore('userData', { keyPath: 'key' });
                    }
                };
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function getCachedData(key) {
            try {
                const db = await openDb();
                return await new Promise((resolve) => {
                    const tx = db.transaction('userData', 'readonly');
                    const store = tx.objectStore('userData');
                    const req = store.get(key);
                    req.onsuccess = () => resolve(req.result || null);
                    req.onerror = () => resolve(null);
                });
            } catch {
                return null;
            }
        }

        async function setCachedData(key, data) {
            try {
                const db = await openDb();
                await new Promise((resolve) => {
                    const tx = db.transaction('userData', 'readwrite');
                    const store = tx.objectStore('userData');
                    store.put({ key, ts: Date.now(), data });
                    tx.oncomplete = () => resolve();
                    tx.onerror = () => resolve();
                });
            } catch {}
        }

        async function fetchUserData(userId) {
            if (fetchPromise) return fetchPromise;
            fetchPromise = new Promise(async (resolve, reject) => {
                try {
                    if (!navigator.onLine) {
                        reject(new Error('offline'));
                        return;
                    }
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 6000);
                    const response = await fetch(`/api/user-data?tg_id=${userId}`, { signal: controller.signal });
                    clearTimeout(timeoutId);
                    if (!response.ok) {
                        reject(new Error('Server xatosi'));
                        return;
                    }
                    const freshData = await response.json();
                    if (!freshData || freshData.error) {
                        reject(new Error('Real ma\'lumotlarni olishda xatolik yuz berdi.'));
                        return;
                    }
                    resolve(freshData);
                } catch (err) {
                    reject(err);
                }
            });
            try {
                const result = await fetchPromise;
                return result;
            } finally {
                fetchPromise = null;
            }
        }

        async function loadData(options = {}) {
            try {
                const user = tg.initDataUnsafe.user;
                if (!user) {
                    tg.showAlert('Foydalanuvchi ma\'lumotlari topilmadi.');
                    return;
                }

                const cacheKey = `user-${user.id}`;
                const cached = await getCachedData(cacheKey);
                if (cached?.data) {
                    userData = cached.data;
                    renderUI();
                    document.getElementById('loader').style.display = 'none';
                }

                const now = Date.now();
                const isFresh = cached?.ts && (now - cached.ts < CACHE_TTL);
                const shouldSoftRefresh = cached?.ts && (now - cached.ts > SOFT_REFRESH_AFTER);
                if (isFresh && !options.force && !shouldSoftRefresh) {
                    return;
                }

                if (document.visibilityState === 'hidden') {
                    return;
                }

                if (now - lastFetchAt < MIN_FETCH_INTERVAL) {
                    return;
                }

                lastFetchAt = now;
                const freshData = await fetchUserData(user.id);
                if (freshData) {
                    userData = freshData;
                    renderUI();
                    await setCachedData(cacheKey, freshData);
                }
            } catch (error) {
                if (!userData) {
                    tg.showAlert('Ma\'lumotlarni yuklashda xatolik yuz berdi.');
                }
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        }

        function renderUI() {
            if (!userData) return;

            document.getElementById('total-tests').innerText = userData.stats?.total_assessments || 0;
            document.getElementById('avg-score').innerText = Math.round(userData.stats?.avg_overall || 0);

            document.getElementById('user-name').innerText = userData.user.first_name || 'Foydalanuvchi';
            document.getElementById('user-id').innerText = userData.user.telegram_id;
            document.getElementById('user-tariff').innerText = userData.user.is_premium ? 'üíé Premium' : 'üÜì Bepul';
            document.getElementById('daily-limit').innerText = `${userData.user.used_today}/${userData.user.daily_limit}`;
            document.getElementById('word-limit').innerText = userData.user.word_limit || 30;

            const tariffsContainer = document.getElementById('tariffs-list');
            tariffsContainer.innerHTML = '';
            (userData.tariffs || []).forEach(t => {
                const card = document.createElement('div');
                card.className = `card tariff-card ${t.is_premium ? 'premium' : ''}`;
                card.innerHTML = `
                    <div class="card-title"><i></i>${t.name}</div>
                    <div class="price">${t.price.toLocaleString()} <span>so'm</span></div>
                    <p class="tariff-desc">${t.description || ''}</p>
                    <button class="btn-action" onclick="sendToBot('select_tariff_${t.id}')">Tanlash</button>
                `;
                tariffsContainer.appendChild(card);
            });
        }

        function switchView(viewId, el) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');

            if (el) {
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                el.classList.add('active');
            }

            tg.HapticFeedback.impactOccurred('light');
        }

        function sendToBot(action) {
            tg.sendData(JSON.stringify({ action: action, source: 'mini_app' }));
            tg.close();
        }

        loadData();
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                loadData();
            }
        });

        if (tg.colorScheme === 'dark') {
            document.body.classList.add('dark-mode');
        }
    </script>
</body>
</html>
