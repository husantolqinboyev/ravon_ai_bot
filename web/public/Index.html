<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ravon AI - User Panel</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<style>
    :root {
    --tg-theme-bg-color: #ffffff;
    --tg-theme-secondary-bg-color: #f5f7fa;
    --tg-theme-text-color: #1a1c1e;
    --tg-theme-hint-color: #707579;
    --tg-theme-button-color: #007aff;
    --tg-theme-button-text-color: #ffffff;
    --primary: #007aff;
    --primary-gradient: linear-gradient(135deg, #007aff, #0056b3);
    --secondary: #5856d6;
    --success: #34c759;
    --warning: #ffcc00;
    --premium: #ff9500;
    --premium-gradient: linear-gradient(135deg, #ff9500, #ffcc00);
    --pure-white: #ffffff;
    --off-white: #f8f9fa;
    --glass-bg: rgba(255, 255, 255, 0.85);
    --border-light: rgba(0, 0, 0, 0.05);
    --card-shadow: 0 8px 24px rgba(0, 122, 255, 0.08);
    --border-radius: 20px;
}

* {
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
    outline: none;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
    background-color: var(--tg-theme-bg-color);
    color: var(--tg-theme-text-color);
    margin: 0;
    padding: 0;
    line-height: 1.4;
    padding-bottom: 94px;
    overflow-x: hidden;
    -webkit-font-smoothing: antialiased;
}

.container {
    width: 100%;
    max-width: 480px;
    margin: 0 auto;
    padding: calc(18px + env(safe-area-inset-top)) 18px 18px;
}

.header {
    text-align: center;
    margin-bottom: 22px;
    padding: 8px 0;
}

.header h1 {
    font-size: 32px;
    font-weight: 800;
    margin: 0;
    background: var(--primary-gradient);
    background-clip: text;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    letter-spacing: -1px;
}

.header p {
    color: var(--tg-theme-hint-color);
    font-size: 15px;
    margin: 6px 0 0;
    font-weight: 500;
}

.card {
    background-color: var(--pure-white);
    border-radius: var(--border-radius);
    padding: 20px;
    margin-bottom: 18px;
    box-shadow: var(--card-shadow);
    border: 1px solid var(--border-light);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.card:active {
    transform: scale(0.99);
}

.card-title {
    font-size: 13px;
    color: var(--primary);
    margin-bottom: 16px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.card-title i {
    width: 6px;
    height: 14px;
    background: var(--primary);
    border-radius: 3px;
    display: inline-block;
}

.stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
}

.stat-item {
    text-align: center;
    padding: 16px 10px;
    background-color: var(--off-white);
    border-radius: 16px;
    border: 1px solid var(--border-light);
}

.stat-value {
    font-size: 26px;
    font-weight: 800;
    display: block;
    color: var(--primary);
    margin-bottom: 2px;
}

.stat-label {
    font-size: 12px;
    color: var(--tg-theme-hint-color);
    font-weight: 600;
}

.btn-action {
    background: var(--primary-gradient);
    color: var(--pure-white);
    border: none;
    border-radius: 16px;
    padding: 16px;
    width: 100%;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    margin-top: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 6px 20px rgba(0, 122, 255, 0.25);
    min-height: 52px;
}

.btn-action:active {
    transform: translateY(2px) scale(0.97);
    box-shadow: 0 2px 10px rgba(0, 122, 255, 0.2);
}

.btn-action.secondary {
    background: #e3f2fd;
    color: var(--primary);
    box-shadow: none;
}

.btn-action.success {
    background: linear-gradient(135deg, var(--success), #28a745);
    box-shadow: 0 6px 20px rgba(52, 199, 89, 0.25);
}

.btn-action.premium-btn {
    background: var(--premium-gradient);
    color: #fff;
    box-shadow: 0 6px 20px rgba(255, 149, 0, 0.3);
}

.bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background-color: var(--glass-bg);
    display: flex;
    justify-content: space-around;
    padding: 10px 0 calc(10px + env(safe-area-inset-bottom));
    border-top: 1px solid rgba(0, 0, 0, 0.05);
    backdrop-filter: blur(25px);
    -webkit-backdrop-filter: blur(25px);
    z-index: 1000;
    box-shadow: 0 -4px 15px rgba(0, 0, 0, 0.03);
}

.nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    color: var(--tg-theme-hint-color);
    text-decoration: none;
    font-size: 11px;
    font-weight: 600;
    width: 30%;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    cursor: pointer;
    min-height: 48px;
    justify-content: center;
}

.nav-item i {
    font-size: 24px;
    margin-bottom: 4px;
    transition: transform 0.2s ease;
}

.nav-item.active {
    color: var(--primary);
}

.nav-item.active i {
    transform: translateY(-4px);
}

.tariff-card {
    position: relative;
    overflow: hidden;
    background: linear-gradient(to bottom right, #ffffff, #fcfcfc);
}

.tariff-card.premium {
    border: 2px solid var(--premium);
    background: linear-gradient(to bottom right, #ffffff, #fffef0);
}

.tariff-card.premium::after {
    content: "TOP";
    position: absolute;
    top: 12px;
    right: -25px;
    background: var(--premium);
    color: #fff;
    padding: 4px 30px;
    font-size: 10px;
    font-weight: 800;
    transform: rotate(45deg);
}

.price {
    font-size: 32px;
    font-weight: 900;
    margin: 16px 0;
    color: var(--tg-theme-text-color);
    display: flex;
    align-items: baseline;
    gap: 4px;
}

.price span {
    font-size: 14px;
    color: var(--tg-theme-hint-color);
    font-weight: 600;
}

.tariff-desc {
    font-size: 13px;
    color: var(--tg-theme-hint-color);
    margin-bottom: 15px;
}

.info-row {
    display: flex;
    justify-content: space-between;
    padding: 14px 0;
    border-bottom: 1px solid var(--border-light);
    gap: 10px;
}

.info-row:last-child {
    border-bottom: none;
}

.info-label {
    color: var(--tg-theme-hint-color);
    font-weight: 600;
    font-size: 14px;
}

.info-value {
    font-weight: 700;
    color: var(--tg-theme-text-color);
    font-size: 14px;
    text-align: right;
}

.view {
    display: none;
    animation: slideUpFade 0.4s cubic-bezier(0.16, 1, 0.3, 1);
}

.view.active {
    display: block;
}

@keyframes slideUpFade {
    from { opacity: 0; transform: translateY(30px); }
    to { opacity: 1; transform: translateY(0); }
}

#loader {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--tg-theme-bg-color);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 2000;
}

.spinner {
    width: 50px;
    height: 50px;
    border: 5px solid var(--tg-theme-secondary-bg-color);
    border-top: 5px solid var(--primary);
    border-radius: 50%;
    animation: spin 1s cubic-bezier(0.5, 0.1, 0.4, 0.9) infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

@media (max-width: 380px) {
    .header h1 { font-size: 28px; }
    .card { padding: 16px; }
    .stat-value { font-size: 22px; }
    .price { font-size: 28px; }
}

body.dark-mode {
    --tg-theme-bg-color: #1a1a1c;
    --tg-theme-secondary-bg-color: #2c2c2e;
    --tg-theme-text-color: #ffffff;
    --pure-white: #242426;
    --off-white: #2c2c2e;
    --glass-bg: rgba(26, 26, 28, 0.85);
    --border-light: rgba(255, 255, 255, 0.05);
}

</style>
<body>
    <div id="loader"><div class="spinner"></div></div>

    <div class="container">
        <div id="view-home" class="view active">
            <div class="header">
                <h1>üéô Ravon AI</h1>
                <p>Nutqingizni ravon qiling</p>
            </div>

            <div class="card">
                <div class="card-title"><i></i>Asosiy Amallar</div>
                <button class="btn-action" onclick="sendToBot('check_pronunciation')">üéô Talaffuzni Tekshirish</button>
                <button class="btn-action secondary" onclick="sendToBot('text_to_audio')">üîä Matnni Audioga O'tkazish</button>
            </div>

            <div class="card">
                <div class="card-title"><i></i>Statistika</div>
                <div class="stats-grid" id="home-stats">
                    <div class="stat-item">
                        <span class="stat-value" id="total-tests">0</span>
                        <span class="stat-label">Jami testlar</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="avg-score">0</span>
                        <span class="stat-label">O'rtacha ball</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-profile" class="view">
            <div class="header"><h1>üë§ Profil</h1></div>
            
            <div class="card">
                <div class="card-title"><i></i>Foydalanuvchi ma'lumotlari</div>
                <div id="user-info">
                    <div class="info-row">
                        <span class="info-label">Ism:</span>
                        <span class="info-value" id="user-name">...</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ID:</span>
                        <span class="info-value" id="user-id">...</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Tarif:</span>
                        <span class="info-value" id="user-tariff">...</span>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-title"><i></i>Limitlar</div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <span class="stat-value" id="daily-limit">0/3</span>
                        <span class="stat-label">Kunlik foydalanish</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="word-limit">30</span>
                        <span class="stat-label">So'z limiti</span>
                    </div>
                </div>
            </div>

            <button class="btn-action premium-btn" onclick="switchView('view-tariffs')">üíé Premiumga o'tish</button>
        </div>

        <div id="view-tariffs" class="view">
            <div class="header"><h1>üí≥ Tariflar</h1></div>
            <div id="tariffs-list"></div>
        </div>
    </div>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="switchView('view-home', this)">
            <i>üè†</i><span>Asosiy</span>
        </div>
        <div class="nav-item" onclick="switchView('view-profile', this)">
            <i>üë§</i><span>Profil</span>
        </div>
        <div class="nav-item" onclick="switchView('view-tariffs', this)">
            <i>üíé</i><span>Tariflar</span>
        </div>
    </nav>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        let userData = null;
        const CACHE_TTL = 12 * 60 * 1000;
        const SOFT_REFRESH_AFTER = 90 * 1000;
        const MIN_FETCH_INTERVAL = 120 * 1000;
        let fetchPromise = null;
        let lastFetchAt = 0;

        function openDb() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('ravon-miniapp', 1);
                request.onupgradeneeded = () => {
                    const db = request.result;
                    if (!db.objectStoreNames.contains('userData')) {
                        db.createObjectStore('userData', { keyPath: 'key' });
                    }
                };
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function getCachedData(key) {
            try {
                const db = await openDb();
                return await new Promise((resolve) => {
                    const tx = db.transaction('userData', 'readonly');
                    const store = tx.objectStore('userData');
                    const req = store.get(key);
                    req.onsuccess = () => resolve(req.result || null);
                    req.onerror = () => resolve(null);
                });
            } catch {
                return null;
            }
        }

        async function setCachedData(key, data) {
            try {
                const db = await openDb();
                await new Promise((resolve) => {
                    const tx = db.transaction('userData', 'readwrite');
                    const store = tx.objectStore('userData');
                    store.put({ key, ts: Date.now(), data });
                    tx.oncomplete = () => resolve();
                    tx.onerror = () => resolve();
                });
            } catch {}
        }

        async function fetchUserData(userId) {
            if (fetchPromise) return fetchPromise;
            fetchPromise = new Promise(async (resolve, reject) => {
                try {
                    if (!navigator.onLine) {
                        reject(new Error('offline'));
                        return;
                    }
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 6000);
                    const response = await fetch(`/api/user-data?tg_id=${userId}`, { signal: controller.signal });
                    clearTimeout(timeoutId);
                    if (!response.ok) {
                        reject(new Error('Server xatosi'));
                        return;
                    }
                    const freshData = await response.json();
                    if (!freshData || freshData.error) {
                        reject(new Error('Real ma\'lumotlarni olishda xatolik yuz berdi.'));
                        return;
                    }
                    resolve(freshData);
                } catch (err) {
                    reject(err);
                }
            });
            try {
                const result = await fetchPromise;
                return result;
            } finally {
                fetchPromise = null;
            }
        }

        async function loadData(options = {}) {
            try {
                const user = tg.initDataUnsafe.user;
                if (!user) {
                    tg.showAlert('Foydalanuvchi ma\'lumotlari topilmadi.');
                    return;
                }

                const cacheKey = `user-${user.id}`;
                const cached = await getCachedData(cacheKey);
                if (cached?.data) {
                    userData = cached.data;
                    renderUI();
                    document.getElementById('loader').style.display = 'none';
                }

                const now = Date.now();
                const isFresh = cached?.ts && (now - cached.ts < CACHE_TTL);
                const shouldSoftRefresh = cached?.ts && (now - cached.ts > SOFT_REFRESH_AFTER);
                if (isFresh && !options.force && !shouldSoftRefresh) {
                    return;
                }

                if (document.visibilityState === 'hidden') {
                    return;
                }

                if (now - lastFetchAt < MIN_FETCH_INTERVAL) {
                    return;
                }

                lastFetchAt = now;
                const freshData = await fetchUserData(user.id);
                if (freshData) {
                    userData = freshData;
                    renderUI();
                    await setCachedData(cacheKey, freshData);
                }
            } catch (error) {
                if (!userData) {
                    tg.showAlert('Ma\'lumotlarni yuklashda xatolik yuz berdi.');
                }
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        }

        function renderUI() {
            if (!userData) return;

            document.getElementById('total-tests').innerText = userData.stats?.total_assessments || 0;
            document.getElementById('avg-score').innerText = Math.round(userData.stats?.avg_overall || 0);

            document.getElementById('user-name').innerText = userData.user.first_name || 'Foydalanuvchi';
            document.getElementById('user-id').innerText = userData.user.telegram_id;
            document.getElementById('user-tariff').innerText = userData.user.is_premium ? 'üíé Premium' : 'üÜì Bepul';
            document.getElementById('daily-limit').innerText = `${userData.user.used_today}/${userData.user.daily_limit}`;
            document.getElementById('word-limit').innerText = userData.user.word_limit || 30;

            const tariffsContainer = document.getElementById('tariffs-list');
            tariffsContainer.innerHTML = '';
            (userData.tariffs || []).forEach(t => {
                const card = document.createElement('div');
                card.className = `card tariff-card ${t.is_premium ? 'premium' : ''}`;
                card.innerHTML = `
                    <div class="card-title"><i></i>${t.name}</div>
                    <div class="price">${t.price.toLocaleString()} <span>so'm</span></div>
                    <p class="tariff-desc">${t.description || ''}</p>
                    <button class="btn-action" onclick="sendToBot('select_tariff_${t.id}')">Tanlash</button>
                `;
                tariffsContainer.appendChild(card);
            });
        }

        function switchView(viewId, el) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');

            if (el) {
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                el.classList.add('active');
            }

            tg.HapticFeedback.impactOccurred('light');
        }

        function sendToBot(action) {
            tg.sendData(JSON.stringify({ action: action, source: 'mini_app' }));
            tg.close();
        }

        loadData();
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                loadData();
            }
        });

        if (tg.colorScheme === 'dark') {
            document.body.classList.add('dark-mode');
        }
    </script>
</body>
</html>
